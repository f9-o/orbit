name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  GO_VERSION: "1.23"

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests before release
        run: go test -count=1 -short ./...

      - name: Build release binaries
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          COMMIT="${GITHUB_SHA::8}"
          DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          PKG="github.com/f9-o/orbit/internal/cli/commands"
          LDFLAGS="-s -w -X ${PKG}.Version=${TAG} -X ${PKG}.Commit=${COMMIT} -X ${PKG}.BuildDate=${DATE}"

          mkdir -p dist

          platforms=(
            "linux/amd64"
            "linux/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "windows/amd64"
          )

          for platform in "${platforms[@]}"; do
            GOOS="${platform%%/*}"
            GOARCH="${platform##*/}"
            EXT=""
            if [ "$GOOS" = "windows" ]; then EXT=".exe"; fi

            BINARY="dist/orbit-${GOOS}-${GOARCH}${EXT}"
            CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH \
              go build -ldflags "${LDFLAGS}" -o "${BINARY}" ./cmd/orbit

            echo "Built: ${BINARY}"
          done

      - name: Generate checksums
        run: |
          cd dist
          sha256sum orbit-* > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          generate_release_notes: true
          files: |
            dist/orbit-linux-amd64
            dist/orbit-linux-arm64
            dist/orbit-darwin-amd64
            dist/orbit-darwin-arm64
            dist/orbit-windows-amd64.exe
            dist/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
